
#' Make QAQC report for a deployment
#'
#' `make_deployment_report()` Will make an html report to use while conducting
#'  quality assurance and quality control (QAQC) on a deployment.  It
#'  uses the "Auto_QC" CSV file generated by "qc_deployment()".
#'
#'  If an output ".html" file exists it will be rewritten.
#'
#' @param dir A deployment directory
#' @param quiet Set to `TRUE` for less chatter. Passed to [rmarkdown::render()].
#'
#' @return Invisibly returns the path the the QC report
#' @export
#'
#' @examples
#' \dontrun{
#'
#' example_paths <- setup_example_dir()
#' dir <- example_paths$deployment
#' qc_deployment(dir, report = FALSE)
#' report_path <-  make_deployment_report(dir)
#' }
make_deployment_report <- function(dir, quiet = FALSE) {

  #----------------------------------------------------------------------------#
  # Set paths
  #----------------------------------------------------------------------------#

  paths <- lookup_paths(deployment_dir = dir)
  site <- paths$site
  deployment_date <- paths$deployment_date


  #----------------------------------------------------------------------------#
  # Identify preceding deployment data file and store in
  #  paths$preceding_data   NA indicates none found
  #----------------------------------------------------------------------------#
  deps <- list.files(paths$site_dir,
                     pattern =
                       "^[[:digit:]]{4}-[[:digit:]]{2}-[[:digit:]]{2}$")
  other_deps <- setdiff(deps, deployment_date) |>
    lubridate::as_date()
  preceding_deps <-
    other_deps[other_deps < lubridate::as_date(deployment_date)]
  if (length(preceding_deps > 0)) {
    preceding_dep <-  max(preceding_deps)
    preceding_dep_dir <- file.path(paths$site_dir, preceding_dep)
    # data_names are possible files for the preceding deployment
    data_names <- paste0(c("QC", "Auto_QC"),
                         "_", site, "_",
                         preceding_dep, ".csv")
    data_paths <- file.path(preceding_dep_dir, data_names)

    paths$preceding_data <- data_paths[file.exists(data_paths)][1]

    rm(preceding_dep, preceding_dep_dir, data_names, data_paths)
  } else {
    paths$preceding_data <- NA
  }
  rm(deps, other_deps, preceding_deps)

  #----------------------------------------------------------------------------#
  # Check for required input files
  #----------------------------------------------------------------------------#
  required <- c("deployment_auto_qc", "sites", "deployment_metadata")
  for (i in seq_along(required)) {
    if (!file.exists(paths[[required[i]]]))
      stop("Required ", required[i], " file is missing.  Expected at: ",
           paths[[required[i]]])
  }

  #----------------------------------------------------------------------------#
  # Knit rmarkdown into html report
  #----------------------------------------------------------------------------#

  template_rmd <- system.file("rmd/QAQC_report.rmd", package = "BuzzardsBay",
                              mustWork = TRUE)

  rmarkdown::render(input = template_rmd,
                    output_file = paths$deployment_report,
                    params = list(paths = paths),
                    quiet = quiet)


  if (FALSE) {
    # Run this manually to step through QAQC_report.Rmd
    # nolint start: object_usage_linter
    data_path <-  paths$deployment_auto_qc
    sites_path <- paths$sites
    metadata_path <- paths$deployment_metadata
    preceding_data_path <- paths$preceding_data
    # nolint end: object_usage_linter
  }

  return(invisible(paths$deployment_report))

}
